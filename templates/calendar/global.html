{% extends 'base.html' %}

{% block title %}Calendrier Global - rosa{% endblock %}

{% block page_header %}
<div class="flex items-center justify-between">
    <div>
        <h1 class="text-2xl font-bold text-gray-900">
            <i class="fas fa-users text-blue-600 mr-2"></i>
            Calendrier Global
        </h1>
        <p class="text-gray-600 mt-1">
            Semaine du {{ week_start|date:"d/m/Y" }} au {{ week_end|date:"d/m/Y" }} - Tous les bénévoles
        </p>
    </div>
    <div class="flex space-x-3">
        <!-- Navigation par semaine -->
        <div class="flex bg-white rounded-lg shadow border">
            <a href="?week={{ prev_week|date:'Y-m-d' }}"
               class="px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-l-lg border-r">
                <i class="fas fa-chevron-left"></i>
            </a>
            <a href="{% url 'calendar:global' %}"
               class="px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 border-r">
                Cette semaine
            </a>
            <a href="?week={{ next_week|date:'Y-m-d' }}"
               class="px-3 py-2 text-gray-600 hover:bg-gray-50 rounded-r-lg">
                <i class="fas fa-chevron-right"></i>
            </a>
        </div>

        <!-- Vue personnelle -->
        <a href="{% url 'calendar:week' %}"
           class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <i class="fas fa-user mr-2"></i>Mon Calendrier
        </a>

        <!-- Boutons d'action -->
        <a href="{% url 'calendar:appointment_create' %}{% if request.GET.as_user %}?as_user={{ request.GET.as_user }}{% endif %}"
           class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
            <i class="fas fa-plus mr-2"></i>Nouveau RDV
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Résumé global -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-users text-blue-600 text-2xl"></i>
                </div>
                <div class="ml-4">
                    <div class="text-sm font-medium text-gray-500">Bénévoles actifs</div>
                    <div class="text-2xl font-bold text-gray-900">{{ calendars|length }}</div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-calendar-check text-green-600 text-2xl"></i>
                </div>
                <div class="ml-4">
                    <div class="text-sm font-medium text-gray-500">RDV cette semaine</div>
                    <div class="text-2xl font-bold text-gray-900">{{ appointments|length }}</div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-clock text-yellow-600 text-2xl"></i>
                </div>
                <div class="ml-4">
                    <div class="text-sm font-medium text-gray-500">Heures planifiées</div>
                    <div class="text-2xl font-bold text-gray-900">{{ total_hours|default:"0" }}h</div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-user-plus text-purple-600 text-2xl"></i>
                </div>
                <div class="ml-4">
                    <div class="text-sm font-medium text-gray-500">Bénéficiaires vus</div>
                    <div class="text-2xl font-bold text-gray-900">{{ unique_beneficiaries|default:"0" }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendrier global par bénévole -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-medium text-gray-900">
                    Planning des bénévoles
                </h2>
                <div class="flex items-center space-x-6">
                    <!-- Filtre par bénévole -->
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-search text-gray-400 text-sm"></i>
                        <input type="text" id="volunteer-filter" placeholder="Filtrer par bénévole..."
                               class="text-sm border border-gray-300 rounded-md px-3 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <!-- Toggles d'affichage -->
                    <div class="flex items-center space-x-4 text-xs">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="show-appointments" checked class="mr-2">
                            <div class="w-4 h-4 bg-blue-100 border border-blue-300 rounded mr-2"></div>
                            <span class="text-gray-600">Rendez-vous</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="show-availability" checked class="mr-2">
                            <div class="w-4 h-4 bg-green-50 border border-green-200 rounded mr-2"></div>
                            <span class="text-gray-600">Disponibilités</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-48">
                            Bénévole
                        </th>
                        {% for day in week_data %}
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider {% if day.date < today %}bg-gray-100{% endif %}">
                            {{ day.date|date:"D d/m" }}
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <!-- Ligne spéciale pour les rendez-vous sans bénévoles assignés -->
                    {% if orphan_appointments %}
                    <tr class="bg-yellow-50 hover:bg-yellow-100 border-l-4 border-yellow-400">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <div class="h-10 w-10 rounded-full bg-yellow-100 flex items-center justify-center">
                                        <i class="fas fa-exclamation-triangle text-yellow-600"></i>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">
                                        Rendez-vous sans bénévoles assignés
                                    </div>
                                    <div class="text-sm text-yellow-600">
                                        {{ orphan_appointments.count }} rendez-vous orphelin{{ orphan_appointments.count|pluralize }}
                                    </div>
                                </div>
                            </div>
                        </td>
                        {% for day in week_data %}
                        <td class="px-2 py-4 text-center {% if day.date < today %}bg-gray-100{% endif %}">
                            <div class="space-y-1 min-h-24">
                                {% for appointment in day.orphan_appointments %}
                                <div class="appointment-item bg-yellow-100 border border-yellow-400 rounded p-1 text-xs mb-1 cursor-pointer hover:bg-yellow-200"
                                     onclick="viewAppointment({{ appointment.id }})">
                                    <div class="font-medium text-yellow-800">
                                        {{ appointment.start_time|time:"H:i" }}-{{ appointment.end_time|time:"H:i" }}
                                    </div>
                                    <div class="text-yellow-700 truncate text-xs">
                                        {{ appointment.beneficiary.last_name|truncatechars:8 }}
                                    </div>
                                    <div class="text-yellow-600 text-xs">
                                        Sans bénévole
                                    </div>
                                </div>
                                {% endfor %}
                                {% if not day.orphan_appointments %}
                                <div class="text-xs text-gray-300 py-2">
                                    -
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        {% endfor %}
                    </tr>
                    {% endif %}

                    {% for calendar in calendars %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                                        <span class="text-sm font-medium text-blue-600">
                                            {{ calendar.volunteer.user.first_name|first }}{{ calendar.volunteer.user.last_name|first }}
                                        </span>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">
                                        {{ calendar.volunteer.user.get_full_name }}
                                    </div>
                                    <div class="text-sm text-gray-500">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                                            {% if calendar.volunteer.role == 'ADMIN' %}bg-red-100 text-red-800
                                            {% elif calendar.volunteer.role == 'EMPLOYEE' %}bg-blue-100 text-blue-800
                                            {% else %}bg-green-100 text-green-800{% endif %}">
                                            {{ calendar.volunteer.get_role_display }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </td>
                        {% for day in week_data %}
                        <td class="px-2 py-4 text-center {% if day.date < today %}bg-gray-100{% endif %}">
                            <div class="space-y-1 min-h-24">
                                {% for vol_data in day.volunteers %}
                                    {% if vol_data.calendar.id == calendar.id %}
                                        <!-- RDV du jour pour ce bénévole -->
                                        {% for appointment in vol_data.appointments %}
                                        <div class="appointment-item bg-blue-100 border border-blue-300 rounded p-1 text-xs mb-1 cursor-pointer hover:bg-blue-200"
                                             onclick="viewAppointment({{ appointment.id }})">
                                            <div class="font-medium text-blue-800">
                                                {{ appointment.start_time|time:"H:i" }}-{{ appointment.end_time|time:"H:i" }}
                                            </div>
                                            <div class="text-blue-600 truncate">
                                                {{ appointment.beneficiary.last_name }}
                                            </div>
                                        </div>
                                        {% endfor %}

                                        <!-- Créneaux de disponibilité pour ce jour -->
                                        {% for slot in vol_data.availability_slots %}
                                        <div class="availability-item bg-green-50 border border-green-200 rounded p-1 text-xs mb-1 cursor-pointer hover:bg-green-100"
                                             data-slot-id="{{ slot.id }}"
                                             data-calendar-id="{{ calendar.id }}"
                                             data-date="{{ day.date|date:'Y-m-d' }}"
                                             data-start-time="{{ slot.start_time|time:'H:i' }}"
                                             data-end-time="{{ slot.end_time|time:'H:i' }}"
                                             onclick="selectAvailabilitySlot(this)">
                                            <div class="font-medium text-green-700">
                                                {{ slot.start_time|time:"H:i" }}-{{ slot.end_time|time:"H:i" }}
                                            </div>
                                            <div class="text-green-600 text-xs">
                                                {% if slot.title %}{{ slot.title|truncatechars:10 }}{% else %}Disponible{% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}

                                        <!-- Indicateur si pas de données -->
                                        {% if not vol_data.appointments and not vol_data.availability_slots %}
                                        <div class="text-xs text-gray-300 py-2">
                                            -
                                        </div>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Détails des rendez-vous de la semaine -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Liste des RDV -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">
                <i class="fas fa-list text-blue-600 mr-2"></i>
                Rendez-vous de la semaine
            </h3>
            {% if appointments %}
                <div class="space-y-3 max-h-96 overflow-y-auto">
                    {% for appointment in appointments %}
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex-1">
                            <div class="font-medium text-gray-900">
                                {{ appointment.beneficiary.first_name }} {{ appointment.beneficiary.last_name }}
                            </div>
                            <div class="text-sm text-gray-600">
                                {{ appointment.appointment_date|date:"d/m/Y" }} à {{ appointment.start_time|time:"H:i" }}
                            </div>
                            <div class="text-sm text-gray-500">
                                avec {{ appointment.volunteer_calendar.volunteer.user.get_full_name }}
                            </div>
                        </div>
                        <div class="ml-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                {% if appointment.status == 'SCHEDULED' %}bg-yellow-100 text-yellow-800
                                {% elif appointment.status == 'CONFIRMED' %}bg-green-100 text-green-800
                                {% elif appointment.status == 'COMPLETED' %}bg-blue-100 text-blue-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ appointment.get_status_display }}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-500 text-sm">Aucun rendez-vous programmé cette semaine.</p>
            {% endif %}
        </div>

        <!-- Actions et statistiques -->
        <div class="space-y-6">
            <!-- Actions rapides -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">
                    <i class="fas fa-bolt text-blue-600 mr-2"></i>
                    Actions rapides
                </h3>
                <div class="space-y-2">
                    <a href="{% url 'calendar:appointment_create' %}{% if request.GET.as_user %}?as_user={{ request.GET.as_user }}{% endif %}"
                       class="w-full btn-success text-center block">
                        <i class="fas fa-plus mr-2"></i>Créer un rendez-vous
                    </a>
                    <a href="{% url 'calendar:appointment_list' %}{% if request.GET.as_user %}?as_user={{ request.GET.as_user }}{% endif %}"
                       class="w-full btn-primary text-center block">
                        <i class="fas fa-list mr-2"></i>Tous les rendez-vous
                    </a>
                    <a href="{% url 'volunteers:list' %}"
                       class="w-full btn-secondary text-center block">
                        <i class="fas fa-users mr-2"></i>Gérer les bénévoles
                    </a>
                </div>
            </div>

            <!-- Répartition par statut -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">
                    <i class="fas fa-chart-pie text-blue-600 mr-2"></i>
                    Répartition des RDV
                </h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Programmés</span>
                        <span class="font-medium text-yellow-600">
                            {{ appointments|length }}
                        </span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Confirmés</span>
                        <span class="font-medium text-green-600">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Terminés</span>
                        <span class="font-medium text-blue-600">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Fonction pour voir les détails d'un rendez-vous
function viewAppointment(appointmentId) {
    const urlParams = new URLSearchParams(window.location.search);
    const asUser = urlParams.get('as_user');
    let url = `/calendrier/appointments/${appointmentId}/`;
    if (asUser) {
        url += `?as_user=${asUser}`;
    }
    window.location.href = url;
}

// Fonction pour sélectionner un créneau de disponibilité
function selectAvailabilitySlot(element) {
    const slotId = element.dataset.slotId;
    const calendarId = element.dataset.calendarId;
    const date = element.dataset.date;
    const startTime = element.dataset.startTime;
    const endTime = element.dataset.endTime;

    // Construire l'URL de création de rendez-vous avec les paramètres pré-remplis
    const url = new URL('{% url "calendar:appointment_create" %}', window.location.origin);
    url.searchParams.set('date', date);
    url.searchParams.set('start_time', startTime);
    url.searchParams.set('end_time', endTime);
    url.searchParams.set('volunteer_calendar', calendarId);

    // Rediriger vers la page de création
    window.location.href = url.toString();
}

document.addEventListener('DOMContentLoaded', function() {
    // Gestion des toggles d'affichage
    const showAppointmentsToggle = document.getElementById('show-appointments');
    const showAvailabilityToggle = document.getElementById('show-availability');

    showAppointmentsToggle.addEventListener('change', function() {
        const appointmentItems = document.querySelectorAll('.appointment-item');
        appointmentItems.forEach(item => {
            item.style.display = this.checked ? 'block' : 'none';
        });
    });

    showAvailabilityToggle.addEventListener('change', function() {
        const availabilityItems = document.querySelectorAll('.availability-item');
        availabilityItems.forEach(item => {
            item.style.display = this.checked ? 'block' : 'none';
        });
    });

    // Filtre par bénévole
    const volunteerFilter = document.getElementById('volunteer-filter');
    const volunteerRows = document.querySelectorAll('tbody tr');

    volunteerFilter.addEventListener('input', function() {
        const filterText = this.value.toLowerCase().trim();

        volunteerRows.forEach(row => {
            const volunteerName = row.querySelector('.text-sm.font-medium.text-gray-900');
            if (volunteerName) {
                const name = volunteerName.textContent.toLowerCase();
                if (filterText === '' || name.includes(filterText)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        });

        // Message si aucun résultat
        const visibleRows = Array.from(volunteerRows).filter(row => row.style.display !== 'none');
        if (visibleRows.length === 0 && filterText !== '') {
            // Afficher un message "aucun résultat" si nécessaire
            console.log('Aucun bénévole trouvé pour:', filterText);
        }
    });

    // Auto-refresh des données toutes les 5 minutes
    setInterval(() => {
        // En production, implémenter un refresh HTMX
        console.log('Refresh automatique des données du calendrier global');
    }, 300000);

    // Highlight des créneaux au survol
    const availabilitySlots = document.querySelectorAll('[data-slot-id]');
    availabilitySlots.forEach(slot => {
        slot.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.05)';
            this.style.zIndex = '10';
        });

        slot.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
            this.style.zIndex = 'auto';
        });
    });

    // Tooltip informatif
    const appointments = document.querySelectorAll('[onclick*="viewAppointment"]');
    appointments.forEach(app => {
        app.title = "Cliquer pour voir les détails du rendez-vous";
    });

    availabilitySlots.forEach(slot => {
        const startTime = slot.dataset.startTime;
        const endTime = slot.dataset.endTime;
        const date = new Date(slot.dataset.date).toLocaleDateString('fr-FR');
        slot.title = `Cliquer pour créer un rendez-vous le ${date} de ${startTime} à ${endTime}`;
    });
});
</script>
{% endblock %}