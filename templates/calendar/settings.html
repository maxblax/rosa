{% extends 'base.html' %}

{% block title %}Paramètres du Calendrier - ONA{% endblock %}

{% block page_header %}
<div class="flex items-center justify-between">
    <div>
        <h1 class="text-2xl font-bold text-gray-900">
            <i class="fas fa-cog text-gray-600 mr-2"></i>
            Paramètres du Calendrier
        </h1>
        <p class="text-gray-600 mt-1">
            Configurez votre calendrier selon vos préférences
        </p>
    </div>
    <div class="flex space-x-3">
        <a href="{% url 'calendar:week' %}" class="btn-secondary">
            <i class="fas fa-arrow-left mr-2"></i>Retour au calendrier
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <form method="post" class="space-y-8">
        {% csrf_token %}

        <!-- Préférences d'affichage -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-eye text-blue-600 mr-2"></i>
                    Préférences d'affichage
                </h3>
                <p class="mt-1 text-sm text-gray-600">
                    Configurez comment vous souhaitez voir votre calendrier.
                </p>
            </div>

            <div class="px-6 py-4 space-y-6">
                <!-- Vue par défaut -->
                <div>
                    <label for="{{ form.default_view.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        {{ form.default_view.label }}
                    </label>
                    <select name="{{ form.default_view.name }}" id="{{ form.default_view.id_for_label }}"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        {% for value, label in form.default_view.field.choices %}
                        <option value="{{ value }}" {% if form.default_view.value == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                    {% if form.default_view.help_text %}
                    <p class="mt-1 text-sm text-gray-500">{{ form.default_view.help_text }}</p>
                    {% endif %}
                </div>

                <!-- Affichage des week-ends -->
                <div>
                    <div class="flex items-center">
                        <input type="checkbox" name="{{ form.show_weekends.name }}" id="{{ form.show_weekends.id_for_label }}"
                               {% if form.show_weekends.value %}checked{% endif %}
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="{{ form.show_weekends.id_for_label }}" class="ml-2 block text-sm text-gray-900">
                            {{ form.show_weekends.label }}
                        </label>
                    </div>
                    {% if form.show_weekends.help_text %}
                    <p class="mt-1 text-sm text-gray-500">{{ form.show_weekends.help_text }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Horaires de travail -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-clock text-green-600 mr-2"></i>
                    Horaires de travail
                </h3>
                <p class="mt-1 text-sm text-gray-600">
                    Définissez vos heures de travail habituelles pour optimiser l'affichage du calendrier.
                </p>
            </div>

            <div class="px-6 py-4 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="{{ form.work_start_time.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            {{ form.work_start_time.label }}
                        </label>
                        <input type="time" name="{{ form.work_start_time.name }}" id="{{ form.work_start_time.id_for_label }}"
                               value="{{ form.work_start_time.value|default:'' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                        {% if form.work_start_time.help_text %}
                        <p class="mt-1 text-sm text-gray-500">{{ form.work_start_time.help_text }}</p>
                        {% endif %}
                    </div>

                    <div>
                        <label for="{{ form.work_end_time.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            {{ form.work_end_time.label }}
                        </label>
                        <input type="time" name="{{ form.work_end_time.name }}" id="{{ form.work_end_time.id_for_label }}"
                               value="{{ form.work_end_time.value|default:'' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                        {% if form.work_end_time.help_text %}
                        <p class="mt-1 text-sm text-gray-500">{{ form.work_end_time.help_text }}</p>
                        {% endif %}
                    </div>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-info-circle text-blue-400"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-blue-800">
                                Ces horaires servent à optimiser l'affichage de votre calendrier. Les créneaux en dehors de ces heures seront masqués par défaut dans les vues jour et semaine.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications et rappels -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-bell text-yellow-600 mr-2"></i>
                    Notifications et rappels
                </h3>
                <p class="mt-1 text-sm text-gray-600">
                    Configurez les rappels automatiques pour vos rendez-vous.
                </p>
            </div>

            <div class="px-6 py-4 space-y-6">
                <!-- Rappels par email -->
                <div>
                    <div class="flex items-center">
                        <input type="checkbox" name="{{ form.email_reminders.name }}" id="{{ form.email_reminders.id_for_label }}"
                               {% if form.email_reminders.value %}checked{% endif %}
                               class="h-4 w-4 text-yellow-600 focus:ring-yellow-500 border-gray-300 rounded"
                               onchange="toggleReminderSettings()">
                        <label for="{{ form.email_reminders.id_for_label }}" class="ml-2 block text-sm text-gray-900">
                            {{ form.email_reminders.label }}
                        </label>
                    </div>
                    {% if form.email_reminders.help_text %}
                    <p class="mt-1 text-sm text-gray-500">{{ form.email_reminders.help_text }}</p>
                    {% endif %}
                </div>

                <!-- Délai avant rappel -->
                <div id="reminder-settings" class="{% if not form.email_reminders.value %}opacity-50 pointer-events-none{% endif %}">
                    <label for="{{ form.reminder_hours_before.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        {{ form.reminder_hours_before.label }}
                    </label>
                    <select name="{{ form.reminder_hours_before.name }}" id="{{ form.reminder_hours_before.id_for_label }}"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500">
                        <option value="1" {% if form.reminder_hours_before.value == 1 %}selected{% endif %}>1 heure avant</option>
                        <option value="2" {% if form.reminder_hours_before.value == 2 %}selected{% endif %}>2 heures avant</option>
                        <option value="4" {% if form.reminder_hours_before.value == 4 %}selected{% endif %}>4 heures avant</option>
                        <option value="24" {% if form.reminder_hours_before.value == 24 %}selected{% endif %}>1 jour avant</option>
                        <option value="48" {% if form.reminder_hours_before.value == 48 %}selected{% endif %}>2 jours avant</option>
                        <option value="72" {% if form.reminder_hours_before.value == 72 %}selected{% endif %}>3 jours avant</option>
                    </select>
                    {% if form.reminder_hours_before.help_text %}
                    <p class="mt-1 text-sm text-gray-500">{{ form.reminder_hours_before.help_text }}</p>
                    {% endif %}
                </div>

                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-800">
                                Les rappels par email seront envoyés à votre adresse email : <strong>{{ user.email }}</strong>.
                                Assurez-vous que votre adresse email est correcte dans vos paramètres de profil.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistiques et données -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-chart-bar text-purple-600 mr-2"></i>
                    Statistiques du calendrier
                </h3>
                <p class="mt-1 text-sm text-gray-600">
                    Aperçu de votre activité de bénévolat.
                </p>
            </div>

            <div class="px-6 py-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600">{{ total_appointments|default:"0" }}</div>
                        <div class="text-sm text-gray-500">Rendez-vous total</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600">{{ total_hours|default:"0" }}h</div>
                        <div class="text-sm text-gray-500">Heures de bénévolat</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-purple-600">{{ active_slots|default:"0" }}</div>
                        <div class="text-sm text-gray-500">Créneaux actifs</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex justify-end space-x-3">
            <a href="{% url 'calendar:week' %}" class="btn-secondary">
                Annuler
            </a>
            <button type="submit" class="btn-success">
                <i class="fas fa-save mr-2"></i>
                Enregistrer les paramètres
            </button>
        </div>
    </form>

    <!-- Réinitialisation -->
    <div class="mt-8 bg-white shadow rounded-lg">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">
                <i class="fas fa-undo text-red-600 mr-2"></i>
                Réinitialisation
            </h3>
            <p class="mt-1 text-sm text-gray-600">
                Actions de maintenance pour votre calendrier.
            </p>
        </div>

        <div class="px-6 py-4 space-y-4">
            <div class="flex items-center justify-between">
                <div>
                    <h4 class="text-sm font-medium text-gray-900">Réinitialiser les paramètres</h4>
                    <p class="text-sm text-gray-500">Restaurer les paramètres par défaut du calendrier</p>
                </div>
                <button type="button" class="btn-secondary" onclick="resetSettings()">
                    Réinitialiser
                </button>
            </div>

            <div class="flex items-center justify-between">
                <div>
                    <h4 class="text-sm font-medium text-gray-900">Synchroniser les données</h4>
                    <p class="text-sm text-gray-500">Actualiser et synchroniser vos données de calendrier</p>
                </div>
                <button type="button" class="btn-primary" onclick="syncData()">
                    Synchroniser
                </button>
            </div>

            {% if user.volunteer_profile.role in 'ADMIN,EMPLOYEE' %}
            <div class="border-t border-gray-200 pt-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="text-sm font-medium text-gray-900">Exporter les données</h4>
                        <p class="text-sm text-gray-500">Télécharger vos données de calendrier (CSV)</p>
                    </div>
                    <a href="{% url 'calendar:export_data' %}" class="btn-secondary">
                        <i class="fas fa-download mr-2"></i>Exporter
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    function toggleReminderSettings() {
        const emailReminders = document.getElementById('{{ form.email_reminders.id_for_label }}');
        const reminderSettings = document.getElementById('reminder-settings');

        if (emailReminders.checked) {
            reminderSettings.classList.remove('opacity-50', 'pointer-events-none');
        } else {
            reminderSettings.classList.add('opacity-50', 'pointer-events-none');
        }
    }

    // Validation des horaires de travail
    const startTimeInput = document.getElementById('{{ form.work_start_time.id_for_label }}');
    const endTimeInput = document.getElementById('{{ form.work_end_time.id_for_label }}');

    function validateWorkHours() {
        const startTime = startTimeInput.value;
        const endTime = endTimeInput.value;

        if (startTime && endTime && endTime <= startTime) {
            alert('L\'heure de fin doit être postérieure à l\'heure de début');
            endTimeInput.focus();
            return false;
        }
        return true;
    }

    startTimeInput.addEventListener('change', validateWorkHours);
    endTimeInput.addEventListener('change', validateWorkHours);

    // Soumission du formulaire
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        if (!validateWorkHours()) {
            e.preventDefault();
        }
    });

    // Actions spéciales
    window.resetSettings = function() {
        if (confirm('Êtes-vous sûr de vouloir réinitialiser tous les paramètres ?')) {
            // Réinitialiser aux valeurs par défaut
            document.getElementById('{{ form.default_view.id_for_label }}').value = 'week';
            document.getElementById('{{ form.show_weekends.id_for_label }}').checked = false;
            document.getElementById('{{ form.work_start_time.id_for_label }}').value = '08:00';
            document.getElementById('{{ form.work_end_time.id_for_label }}').value = '18:00';
            document.getElementById('{{ form.email_reminders.id_for_label }}').checked = true;
            document.getElementById('{{ form.reminder_hours_before.id_for_label }}').value = '24';

            toggleReminderSettings();

            alert('Paramètres réinitialisés. N\'oubliez pas de sauvegarder.');
        }
    };

    window.syncData = function() {
        if (confirm('Synchroniser les données du calendrier ?')) {
            // En production, faire un appel AJAX
            fetch('/calendrier/sync/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                }
            }).then(response => {
                if (response.ok) {
                    alert('Données synchronisées avec succès');
                } else {
                    alert('Erreur lors de la synchronisation');
                }
            }).catch(error => {
                console.error('Erreur:', error);
                alert('Erreur lors de la synchronisation');
            });
        }
    };

    // Initial setup
    toggleReminderSettings();
});

// Make function global for onchange
function toggleReminderSettings() {
    const event = new Event('change');
    document.getElementById('{{ form.email_reminders.id_for_label }}').dispatchEvent(event);
}
</script>
{% endblock %}