{% extends 'base.html' %}

{% block title %}Analyses - rosa{% endblock %}

{% block page_header %}
<div class="flex items-center justify-between">
    <div>
        <h1 class="text-2xl font-bold text-gray-900">
            <i class="fas fa-chart-bar text-blue-600 mr-2"></i>
            Analyses & Indicateurs
        </h1>
        <p class="text-gray-600 mt-1">Métriques d'impact et données statistiques de l'association</p>
    </div>
    {% if can_export %}
    <div class="flex space-x-3">
        <button class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
            <i class="fas fa-file-pdf mr-2"></i>
            Export PDF
        </button>
        <button class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
            <i class="fas fa-file-powerpoint mr-2"></i>
            Export PPT
        </button>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block content %}
<div class="space-y-8">
    {% for section in sections %}
    <!-- Section -->
    <div class="mb-8 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <div class="border-b border-gray-200 pb-3 mb-6">
            <h2 class="text-xl font-bold text-gray-900">{{ section.label }}</h2>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {% for chart in section.charts %}
            <!-- Chart Card -->
            <div class="{% if chart.size == 'full' %}lg:col-span-2{% endif %} bg-white rounded-lg shadow p-6">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">{{ chart.title }}</h3>
                    {% if chart.description %}
                    <p class="text-sm text-gray-600 mt-1">{{ chart.description }}</p>
                    {% endif %}
                </div>

                {% if chart.has_error %}
                <!-- Error Display -->
                <div class="bg-red-50 border border-red-200 rounded-md p-4">
                    <div class="flex">
                        <i class="fas fa-exclamation-triangle text-red-600 mt-1"></i>
                        <div class="ml-3">
                            <p class="text-sm text-red-800 font-medium">Erreur lors de la génération du graphique</p>
                            <p class="text-sm text-red-700 mt-1">{{ chart.error_message }}</p>
                        </div>
                    </div>
                </div>
                {% else %}
                <!-- Chart Canvas -->
                <div style="position: relative; height: 300px;">
                    <canvas id="chart-{{ chart.id }}"></canvas>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% empty %}
    <!-- No Charts -->
    <div class="text-center py-12">
        <i class="fas fa-chart-bar text-gray-400 text-6xl mb-4"></i>
        <p class="text-gray-600 text-lg">Aucun graphique configuré pour le moment</p>
        <p class="text-gray-500 text-sm mt-2">Les graphiques peuvent être configurés via l'administration Django</p>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Générer tous les graphiques
{% for section in sections %}
{% for chart in section.charts %}
{% if not chart.has_error %}
(function() {
    const ctx = document.getElementById('chart-{{ chart.id }}');
    if (ctx) {
        const chartData = {{ chart.data_json|safe }};

        const config = {
            type: '{{ chart.chart_type }}',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    title: {
                        display: false
                    }
                },
                {% if chart.chart_type == 'line' or chart.chart_type == 'bar' or chart.chart_type == 'stacked_bar' %}
                scales: {
                    y: {
                        beginAtZero: true,
                        {% if chart.y_axis_label %}
                        title: {
                            display: true,
                            text: '{{ chart.y_axis_label }}'
                        },
                        {% endif %}
                        ticks: {
                            precision: 0
                        }
                    },
                    x: {
                        {% if chart.x_axis_label %}
                        title: {
                            display: true,
                            text: '{{ chart.x_axis_label }}'
                        }
                        {% endif %}
                    }
                }
                {% endif %}
                {% if chart.chart_type == 'stacked_bar' %},
                scales: {
                    x: {
                        stacked: true
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true
                    }
                }
                {% endif %}
            }
        };

        new Chart(ctx, config);
    }
})();
{% endif %}
{% endfor %}
{% endfor %}
</script>
{% endblock %}
