{% extends 'base.html' %}

{% block title %}Modifier Partenaire - ONA{% endblock %}

{% block page_header %}
<div class="flex items-center justify-between">
    <div class="flex items-center space-x-4">
        <a href="{% url 'partners:list' %}"
           class="flex items-center text-sm text-gray-500 hover:text-gray-700">
            <i class="fas fa-arrow-left mr-2"></i>
            Retour
        </a>
        <div>
            <h1 class="text-2xl font-bold text-gray-900">
                <i class="fas fa-handshake text-blue-600 mr-2"></i>
                {{ object.name }}
            </h1>
        </div>
    </div>
    <div class="flex space-x-3">
        <a href="{% url 'partners:list' %}"
           class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <i class="fas fa-list mr-2"></i>
            Liste des Partenaires
        </a>
        {% if user.volunteer_profile and user.volunteer_profile.role in 'ADMIN,EMPLOYEE' or user.is_superuser %}
        <a href="{% url 'partners:create' %}"
           class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <i class="fas fa-plus mr-2"></i>
            Nouveau Partenaire
        </a>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto py-8">

    <form method="post" class="space-y-8" id="partner-form">
        {% csrf_token %}

        <!-- Informations du Partenaire -->
        <div class="bg-white shadow sm:rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-6">
                    Informations du Partenaire
                </h3>

                <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                    <!-- Nom -->
                    <div class="sm:col-span-6">
                        <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-gray-700">
                            {{ form.name.label }} <span class="text-red-500">*</span>
                        </label>
                        <div class="mt-1">
                            {{ form.name }}
                        </div>
                        {% if form.name.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.name.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Adresse -->
                    <div class="sm:col-span-6">
                        <label for="{{ form.address.id_for_label }}" class="block text-sm font-medium text-gray-700">
                            {{ form.address.label }}
                        </label>
                        <div class="mt-1">
                            {{ form.address }}
                        </div>
                        {% if form.address.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.address.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Telephone -->
                    <div class="sm:col-span-3">
                        <label for="{{ form.phone.id_for_label }}" class="block text-sm font-medium text-gray-700">
                            {{ form.phone.label }}
                        </label>
                        <div class="mt-1">
                            {{ form.phone }}
                        </div>
                        {% if form.phone.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.phone.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Email -->
                    <div class="sm:col-span-3">
                        <label for="{{ form.email.id_for_label }}" class="block text-sm font-medium text-gray-700">
                            {{ form.email.label }}
                        </label>
                        <div class="mt-1">
                            {{ form.email }}
                        </div>
                        {% if form.email.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.email.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Services Fournis -->
                    <div class="sm:col-span-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Services Fournis
                        </label>

                        <!-- Hidden field pour les services -->
                        {{ form.services }}

                        <!-- Liste des services ajoutes -->
                        <div id="services-list" class="space-y-2 mb-3">
                            <!-- Les services seront ajoutes ici dynamiquement -->
                        </div>

                        <!-- Ajouter un service -->
                        <div class="flex gap-2">
                            <input type="text"
                                   id="new-service-input"
                                   placeholder="Ajouter un service..."
                                   class="flex-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <button type="button"
                                    id="add-service-btn"
                                    class="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 flex items-center">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex justify-between">
            <a href="{% url 'partners:delete' object.pk %}"
               class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500"
               onclick="return confirm('Etes-vous sur de vouloir supprimer ce partenaire ?');">
                <i class="fas fa-trash mr-2"></i>
                Supprimer
            </a>
            <div class="flex space-x-3">
                <a href="{% url 'partners:list' %}"
                   class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500">
                    Annuler
                </a>
                <button type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <i class="fas fa-save mr-2"></i>
                    Enregistrer
                </button>
            </div>
        </div>
    </form>
</div>

<script>
    // Gestion des services
    let services = [];
    let allServices = [];
    const servicesInput = document.getElementById('id_services');
    const servicesList = document.getElementById('services-list');
    const newServiceInput = document.getElementById('new-service-input');
    const addServiceBtn = document.getElementById('add-service-btn');

    // Charger tous les services existants
    fetch('{% url "partners:api_services" %}')
        .then(response => response.json())
        .then(data => {
            allServices = data.services;
        });

    function updateServicesInput() {
        servicesInput.value = services.join(', ');
    }

    function renderServices() {
        servicesList.innerHTML = '';
        services.forEach((service, index) => {
            const serviceEl = document.createElement('div');
            serviceEl.className = 'flex items-center gap-2';
            serviceEl.innerHTML = `
                <span class="flex-1 px-3 py-2 bg-gray-50 rounded-md text-sm">${service}</span>
                <button type="button"
                        onclick="removeService(${index})"
                        class="text-red-600 hover:text-red-900">
                    <i class="fas fa-minus"></i>
                </button>
            `;
            servicesList.appendChild(serviceEl);
        });
    }

    function addService() {
        const service = newServiceInput.value.trim();
        if (service && !services.includes(service)) {
            // Chercher une correspondance exacte (insensible a la casse)
            const existingMatch = allServices.find(s => s.toLowerCase() === service.toLowerCase());
            const serviceToAdd = existingMatch || service;

            services.push(serviceToAdd);
            newServiceInput.value = '';
            updateServicesInput();
            renderServices();
            hideAutocomplete();
        }
    }

    function removeService(index) {
        services.splice(index, 1);
        updateServicesInput();
        renderServices();
    }

    function showAutocomplete(matches) {
        hideAutocomplete();
        if (matches.length === 0) return;

        const autocompleteDiv = document.createElement('div');
        autocompleteDiv.id = 'autocomplete-list';
        autocompleteDiv.className = 'absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 max-h-48 overflow-y-auto';

        matches.forEach(service => {
            const item = document.createElement('div');
            item.className = 'px-3 py-2 hover:bg-blue-50 cursor-pointer text-sm';
            item.textContent = service;
            item.addEventListener('click', () => {
                newServiceInput.value = service;
                hideAutocomplete();
            });
            autocompleteDiv.appendChild(item);
        });

        newServiceInput.parentElement.style.position = 'relative';
        newServiceInput.parentElement.appendChild(autocompleteDiv);
    }

    function hideAutocomplete() {
        const existing = document.getElementById('autocomplete-list');
        if (existing) existing.remove();
    }

    // Autocomplete au fur et a mesure de la saisie
    newServiceInput.addEventListener('input', (e) => {
        const value = e.target.value.trim().toLowerCase();
        if (value.length < 2) {
            hideAutocomplete();
            return;
        }

        const matches = allServices.filter(s =>
            s.toLowerCase().includes(value) && !services.includes(s)
        ).slice(0, 5);

        showAutocomplete(matches);
    });

    // Evenements
    addServiceBtn.addEventListener('click', addService);
    newServiceInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            addService();
        }
    });

    // Cacher l'autocomplete si on clique ailleurs
    document.addEventListener('click', (e) => {
        if (!newServiceInput.contains(e.target)) {
            hideAutocomplete();
        }
    });

    // Initialisation si on a deja des services (mode edition)
    if (servicesInput.value) {
        services = servicesInput.value.split(',').map(s => s.trim()).filter(s => s);
        renderServices();
    }
</script>
{% endblock %}
