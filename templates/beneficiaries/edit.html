{% extends 'base.html' %}

{% block title %}Modifier {{ beneficiary.full_name }} - ONA{% endblock %}

{% block page_header %}
<div class="flex items-center justify-between">
    <h1 class="text-2xl font-bold text-gray-900">Modifier {{ beneficiary.full_name }}</h1>
</div>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Navigation -->
    <div class="mb-6 flex items-center space-x-4">
        <a href="{% url 'beneficiaries:detail' beneficiary.pk %}" 
           class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <i class="fas fa-arrow-left mr-2"></i>
            Retour
        </a>
    </div>

    <form method="post" class="space-y-8">
        {% csrf_token %}
        
        <!-- Informations Personnelles -->
        <div class="bg-white shadow-lg sm:rounded-lg">
            <div class="px-6 py-6 sm:p-8">
                <h3 class="text-xl leading-6 font-semibold text-gray-900 mb-8">
                    Informations Personnelles
                </h3>
                
                <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2">
                    <div>
                        <label for="{{ form.civility.id_for_label }}" class="block text-sm font-medium text-gray-700">
                            {{ form.civility.label }}
                        </label>
                        <div class="mt-1">
                            {{ form.civility }}
                        </div>
                        {% if form.civility.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.civility.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div>
                        <label for="{{ form.first_name.id_for_label }}" class="block text-sm font-medium text-gray-700">
                            {{ form.first_name.label }}
                        </label>
                        <div class="mt-1">
                            {{ form.first_name }}
                        </div>
                        {% if form.first_name.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.first_name.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div>
                        <label for="{{ form.birth_date.id_for_label }}" class="block text-sm font-medium text-gray-700">
                            {{ form.birth_date.label }}
                        </label>
                        <div class="mt-1">
                            {{ form.birth_date }}
                        </div>
                        {% if form.birth_date.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.birth_date.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div>
                        <label for="{{ form.last_name.id_for_label }}" class="block text-sm font-medium text-gray-700">
                            {{ form.last_name.label }}
                        </label>
                        <div class="mt-1">
                            {{ form.last_name }}
                        </div>
                        {% if form.last_name.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.last_name.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div>
                        <label for="{{ form.email.id_for_label }}" class="block text-sm font-medium text-gray-700">
                            {{ form.email.label }}
                        </label>
                        <div class="mt-1">
                            {{ form.email }}
                        </div>
                        {% if form.email.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.email.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div>
                        <label for="{{ form.phone.id_for_label }}" class="block text-sm font-medium text-gray-700">
                            {{ form.phone.label }}
                        </label>
                        <div class="mt-1">
                            {{ form.phone }}
                        </div>
                        {% if form.phone.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.phone.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div>
                        <label for="{{ form.occupation.id_for_label }}" class="block text-sm font-medium text-gray-700">
                            {{ form.occupation.label }}
                        </label>
                        <div class="mt-1">
                            {{ form.occupation }}
                        </div>
                        {% if form.occupation.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.occupation.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="sm:col-span-2">
                        <label for="{{ form.address.id_for_label }}" class="block text-sm font-medium text-gray-700">
                            {{ form.address.label }}
                        </label>
                        <div class="mt-1">
                            {{ form.address }}
                        </div>
                        {% if form.address.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.address.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="sm:col-span-2">
                        <label for="{{ form.residence_address.id_for_label }}" class="block text-sm font-medium text-gray-700">
                            {{ form.residence_address.label }}
                        </label>
                        <div class="mt-1">
                            {{ form.residence_address }}
                        </div>
                        {% if form.residence_address.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.residence_address.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="sm:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            {{ form.housing_status.label }}
                        </label>
                        <div class="flex flex-wrap gap-4">
                            {% for choice in form.housing_status.field.choices %}
                                <label class="inline-flex items-center">
                                    <input type="checkbox" name="housing_status_multi" value="{{ choice.0 }}" 
                                           {% if form.housing_status.value == choice.0 %}checked{% endif %}
                                           class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-700">{{ choice.1 }}</span>
                                </label>
                            {% endfor %}
                        </div>
                        {% if form.housing_status.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.housing_status.errors.0 }}</div>
                        {% endif %}
                        <!-- Hidden field to maintain form compatibility -->
                        <input type="hidden" name="housing_status" id="id_housing_status" value="{{ form.housing_status.value|default:'' }}">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">
                            {{ form.family_status.label }}
                        </label>
                        <div class="mt-3 space-y-3">
                            {% for choice in form.family_status %}
                                <div class="flex items-center">
                                    {{ choice.tag }}
                                    <label for="{{ choice.id_for_label }}" class="ml-2 text-sm text-gray-700">
                                        {{ choice.choice_label }}
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                        {% if form.family_status.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.family_status.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div>
                        <label for="{{ form.dependents_count.id_for_label }}" class="block text-sm font-medium text-gray-700">
                            {{ form.dependents_count.label }}
                        </label>
                        <div class="mt-1">
                            {{ form.dependents_count }}
                        </div>
                        {% if form.dependents_count.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.dependents_count.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div>
                        <label for="{{ form.preferred_contact.id_for_label }}" class="block text-sm font-medium text-gray-700">
                            {{ form.preferred_contact.label }}
                        </label>
                        <div class="mt-1">
                            {{ form.preferred_contact }}
                        </div>
                        {% if form.preferred_contact.help_text %}
                            <p class="mt-1 text-sm text-gray-500">{{ form.preferred_contact.help_text }}</p>
                        {% endif %}
                        {% if form.preferred_contact.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.preferred_contact.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Section Enfants -->
        <div id="children-section" class="bg-white shadow-lg sm:rounded-lg" style="display: none;">
            <div class="px-6 py-6 sm:p-8">
                <h3 class="text-xl leading-6 font-semibold text-gray-900 mb-8">
                    Enfants à Charge
                </h3>
                
                <div id="children-forms">
                    {{ children_formset.management_form }}
                    {% for form in children_formset %}
                        <div class="child-form border border-gray-200 rounded-lg p-4 mb-4">
                            <div class="grid grid-cols-1 gap-y-4 gap-x-4 sm:grid-cols-2">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Prénom</label>
                                    {{ form.first_name }}
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Nom</label>
                                    {{ form.last_name }}
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Date de naissance</label>
                                    {{ form.birth_date }}
                                </div>
                                <div class="sm:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700">Observations</label>
                                    {{ form.observations }}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Boutons d'action -->
        <div class="flex justify-end space-x-3">
            <a href="{% url 'beneficiaries:detail' beneficiary.pk %}" 
               class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Annuler
            </a>
            <button type="submit" 
                    class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Enregistrer les modifications
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const dependentsCountField = document.getElementById('{{ form.dependents_count.id_for_label }}');
    const childrenSection = document.getElementById('children-section');
    const childrenForms = document.getElementById('children-forms');
    
    function toggleChildrenSection() {
        const count = parseInt(dependentsCountField.value) || 0;
        if (count > 0) {
            childrenSection.style.display = 'block';
            updateChildrenForms(count);
        } else {
            childrenSection.style.display = 'none';
        }
    }
    
    function updateChildrenForms(count) {
        // Logique pour ajuster le nombre de formulaires enfants
        const existingForms = childrenForms.querySelectorAll('.child-form');
        const currentCount = existingForms.length;
        
        if (count > currentCount) {
            // Ajouter des formulaires
            for (let i = currentCount; i < count; i++) {
                addChildForm(i);
            }
        } else if (count < currentCount) {
            // Supprimer des formulaires
            for (let i = currentCount - 1; i >= count; i--) {
                existingForms[i].remove();
            }
        }
        
        // Mettre à jour le TOTAL_FORMS
        const totalFormsInput = document.querySelector('[name="children-TOTAL_FORMS"]');
        if (totalFormsInput) {
            totalFormsInput.value = count;
        }
    }
    
    function addChildForm(index) {
        const newForm = document.createElement('div');
        newForm.className = 'child-form border border-gray-200 rounded-lg p-4 mb-4';
        newForm.innerHTML = `
            <div class="grid grid-cols-1 gap-y-4 gap-x-4 sm:grid-cols-2">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Prénom</label>
                    <input type="text" name="children-${index}-first_name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Nom</label>
                    <input type="text" name="children-${index}-last_name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Date de naissance</label>
                    <input type="date" name="children-${index}-birth_date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="sm:col-span-2">
                    <label class="block text-sm font-medium text-gray-700">Observations</label>
                    <textarea name="children-${index}-observations" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
            </div>
        `;
        childrenForms.appendChild(newForm);
    }
    
    // Écouter les changements
    dependentsCountField.addEventListener('change', toggleChildrenSection);
    dependentsCountField.addEventListener('input', toggleChildrenSection);
    
    // Initialiser l'affichage
    toggleChildrenSection();
    
    // Gestion des checkboxes pour l'hébergement (comportement radio)
    const housingCheckboxes = document.querySelectorAll('input[name="housing_status_multi"]');
    const hiddenHousingField = document.getElementById('id_housing_status');
    
    housingCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                // Décocher tous les autres
                housingCheckboxes.forEach(cb => {
                    if (cb !== this) cb.checked = false;
                });
                // Mettre à jour le champ caché
                hiddenHousingField.value = this.value;
            } else {
                // Si on décoche, vider le champ caché
                hiddenHousingField.value = '';
            }
        });
    });
});
</script>
{% endblock %} 