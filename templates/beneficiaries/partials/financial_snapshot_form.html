<!-- Modal overlay -->
<div class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" id="modal-overlay">
    <div class="relative top-10 mx-auto p-6 border w-11/12 max-w-6xl shadow-lg rounded-lg bg-white max-h-screen overflow-hidden">
        <!-- Modal header -->
        <div class="flex items-center justify-between pb-4 border-b sticky top-0 bg-white z-10">
                            <h3 class="text-xl font-semibold text-gray-900">
                    {% if is_update %}
                        Modifier Snapshot Financier - {{ beneficiary.full_name }}
                    {% else %}
                        Nouveau Snapshot Financier - {{ beneficiary.full_name }}
                    {% endif %}
                </h3>
            <button type="button" 
                    onclick="document.getElementById('financial-modal').innerHTML = ''"
                    class="text-gray-400 hover:text-gray-600 text-2xl">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Modal body -->
        <div class="pt-4 overflow-y-auto max-h-[calc(100vh-200px)]">
            <form hx-post="{% url 'beneficiaries:financial_snapshot_create' beneficiary.pk %}"
                  hx-target="#financial-snapshot-list"
                  hx-swap="outerHTML"
                  id="snapshot-form">
                {% csrf_token %}
                
                <div class="space-y-8">
                    <!-- Revenus -->
                    <div class="mb-8">
                        <h4 class="text-md font-medium text-gray-900 mb-4">Revenus</h4>
                        
                        {% for category_name, fields in form.get_revenue_categories %}
                        <div class="mb-6">
                            <h5 class="text-sm font-medium text-gray-700 mb-3 pl-3">{{ category_name }}</h5>
                            <div class="grid grid-cols-1 gap-y-4 gap-x-4 sm:grid-cols-2">
                                {% for field_name, field in fields %}
                                <div>
                                    <label for="{{ field.id_for_label }}" class="block text-xs text-gray-600 pl-3 pb-1">
                                        {{ field.label }}
                                    </label>
                                    <div class="mt-1 relative">
                                        {{ field }}
                                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                            <span class="text-gray-500 text-xs">€</span>
                                        </div>
                                    </div>
                                    {% if field.errors %}
                                        <div class="mt-1 text-xs text-red-600">{{ field.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Charges -->
                    <div class="mb-6">
                        <h4 class="text-md font-medium text-gray-900 mb-4">Charges</h4>
                        
                        {% for category_name, fields in form.get_charge_categories %}
                        <div class="mb-6">
                            <h5 class="text-sm font-medium text-gray-700 mb-3 pl-3">{{ category_name }}</h5>
                            <div class="grid grid-cols-1 gap-y-4 gap-x-4 sm:grid-cols-2">
                                {% for field_name, field in fields %}
                                <div>
                                    <label for="{{ field.id_for_label }}" class="block text-xs text-gray-600 pl-3 pb-1">
                                        {{ field.label }}
                                    </label>
                                    <div class="mt-1 relative">
                                        {{ field }}
                                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                            <span class="text-gray-500 text-xs">€</span>
                                        </div>
                                    </div>
                                    {% if field.errors %}
                                        <div class="mt-1 text-xs text-red-600">{{ field.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Modal footer -->
                <div class="flex justify-end space-x-3 pt-4 border-t sticky bottom-0 bg-white mt-6">
                    <button type="button" 
                            onclick="document.getElementById('financial-modal').innerHTML = ''"
                            class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Annuler
                    </button>
                    <button type="submit" 
                            class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Enregistrer le snapshot
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('snapshot-form');
    const originalValues = {};

    // Stocker les valeurs originales et gérer l'affichage null/0
    const inputs = form.querySelectorAll('input[type="number"]');
    inputs.forEach(input => {
        // Stocker la valeur originale
        originalValues[input.name] = input.value;
        
        // Si la valeur est 0, l'afficher comme vide (null)
        if (input.value === '0' || input.value === '0.00') {
            input.value = '';
            input.placeholder = 'Non renseigné';
        }

        // Ajouter un écouteur d'événement pour détecter les changements
        input.addEventListener('input', function() {
            const currentValue = this.value || '0'; // Traiter vide comme 0 pour la comparaison
            const originalValue = originalValues[this.name] || '0';
            
            console.log(`Field ${this.name}: ${originalValue} -> ${currentValue}`);
            
            if (currentValue !== originalValue) {
                this.classList.add('field-changed');
                console.log(`Added field-changed to ${this.name}`);
            } else {
                this.classList.remove('field-changed');
                console.log(`Removed field-changed from ${this.name}`);
            }
        });
        
        // Gérer le focus pour les valeurs vides
        input.addEventListener('focus', function() {
            if (this.placeholder === 'Non renseigné') {
                this.placeholder = '';
            }
        });
        
        input.addEventListener('blur', function() {
            if (this.value === '') {
                this.placeholder = 'Non renseigné';
            }
        });
    });

    // Fermer le modal après soumission réussie
    form.addEventListener('htmx:afterRequest', function(event) {
        console.log('HTMX Request completed:', event.detail);
        if (event.detail.xhr.status === 200) {
            console.log('Success! Closing modal in 800ms');
            // Fermer le modal après succès
            setTimeout(function() {
                const modal = document.getElementById('financial-modal');
                if (modal) {
                    console.log('Closing modal now');
                    modal.innerHTML = '';
                }
            }, 800);
        }
    });
    
    // Alternative : écouter sur le document pour capturer tous les événements HTMX
    document.addEventListener('htmx:afterSwap', function(event) {
        console.log('HTMX Swap completed:', event.target.id);
        if (event.target.id === 'financial-snapshot-list') {
            console.log('Financial snapshot list updated, closing modal');
            setTimeout(function() {
                const modal = document.getElementById('financial-modal');
                if (modal) {
                    modal.innerHTML = '';
                }
            }, 800);
        }
    });
});
</script> 